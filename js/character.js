// Generated by CoffeeScript 1.3.3
(function() {
  var __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  define(['lib/jquery', 'data', 'entity'], function($, Data, Entity) {
    var Character;
    Character = (function(_super) {

      __extends(Character, _super);

      function Character(id, kind) {
        this.moveStack = [];
        this.orientation = 'down';
        Character.__super__.constructor.call(this, id, kind);
        $(this.elt).addClass('character');
        this.enableSmoothMvmt();
        this.disableSmoothMvmt();
      }

      Character.prototype.setMoveStack = function(moveStack) {
        this.moveStack = moveStack;
        return this.nextMove();
      };

      Character.prototype.move = function(x, y, callback) {
        var _this = this;
        this.setPosition(x, y);
        return setTimeout(function() {
          return callback();
        }, 1000 / this.speed);
      };

      "teleport: (x, y) ->\n@disableSmoothMvmt()\n@setPosition(x, y)\n@enableSmoothMvmt()";


      Character.prototype.nextMove = function() {
        var dest, direction, source,
          _this = this;
        if (!(this.moveStack.length > 1)) {
          return;
        }
        source = this.moveStack[0];
        dest = this.moveStack[1];
        direction = null;
        if (source[0] !== this.x || source[1] !== this.y) {
          throw "Source isn't current character position";
        }
        if (Math.abs(source[0] - dest[0]) + Math.abs(source[1] - dest[1]) > 1) {
          throw "There must be exactly one coordinate change between source and dest";
        }
        if (source[0] - dest[0] === -1) {
          direction = 'right';
        } else if (source[0] - dest[0] === 1) {
          direction = 'left';
        } else if (source[1] - dest[1] === -1) {
          direction = 'down';
        } else if (source[1] - dest[1] === 1) {
          direction = 'up';
        } else {
          throw "Impossible move";
        }
        this.moveTowards(direction, function() {
          return _this.nextMove();
        });
        return this.moveStack.splice(0, 1);
      };

      Character.prototype.moveTowards = function(direction, callback) {
        var pos,
          _this = this;
        pos = {
          x: this.x,
          y: this.y
        };
        switch (direction) {
          case 'left':
            pos.x--;
            break;
          case 'right':
            pos.x++;
            break;
          case 'up':
            pos.y--;
            break;
          case 'down':
            pos.y++;
        }
        this.setAnimation("move_" + direction);
        this.orientation = direction;
        return this.move(pos.x, pos.y, function() {
          _this.setAnimation("idle_" + direction);
          return callback();
        });
      };

      Character.prototype.enableSmoothMvmt = function() {
        this.elt.style.transitionProperty = 'top, left';
        this.elt.style.transitionDuration = (1 / this.speed) + 's';
        return this.elt.style.transitionTimingFunction = 'linear';
      };

      Character.prototype.disableSmoothMvmt = function() {
        this.elt.style.transition = 'none';
        return this.elt.style.transitionProperty = '';
      };

      return Character;

    })(Entity);
    return Character;
  });

}).call(this);
